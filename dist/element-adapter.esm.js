const e=e=>e.length>0?Array.from(new Set(e)):e,t=(e,t)=>r=>e*r[t],r=e=>()=>e,n=(e,t)=>{const r=typeof e,n=typeof t;if(r===n)return!0;throw new Error(`type mismatch: a(${e}) is ${r} and b(${t}) is ${n}`)};var s={">":e=>(t,r)=>{const s=e(t);return n(r,s)&&r>s},">=":e=>(t,r)=>{const s=e(t);return n(r,s)&&r>=s},"<":e=>(t,r)=>{const s=e(t);return n(r,s)&&r<s},"<=":e=>(t,r)=>{const s=e(t);return n(r,s)&&r<=s},"==":e=>(t,r)=>{const s=e(t);return n(r,s)&&r===e(t)}};const i={width:"w%",height:"h%"},o=Object.entries(i).reduce((e,[t,r])=>({...e,[r]:t}),{}),a=(e,t,r)=>{if(0===t.length)return;const n=document.createElement("b");n.style.position="absolute",e.appendChild(n);const s=t.reduce((e,t)=>({...e,[t]:r(n,t)}),{});return e.removeChild(n),s},c=(e,t)=>a(e,t,(e,t)=>(e.style.width="1"+t,e.getBoundingClientRect().width)),p=(e,t)=>a(e.parentNode,t,(e,t)=>{const r=o[t];e.style[r]="1%";const{[r]:n}=e.getBoundingClientRect();return n}),u=e=>["width","height"].includes(e),d=(e,t)=>e>t?"landscape":e<t?"portrait":"square",h=(e,t)=>0===e&&0===t?1:e/t,l=["width","height","aspect-ratio","orientation","children","characters"],m=["%","cap","ch","em","ex","ic","lh","rem","rlh","vb","vh","vi","vw","vmin","vmax","mm","Q","cm","in","pt","pc"],w=new RegExp(`^(\\d+(\\.\\d+)?)(${m.join("|")})$`),f=/^\d+(\.\d+)?(px)?$/,g=e=>{const n=e.trim().toLowerCase().split(/\s*,\s*/),o=[],a=[],c=[],p=[];for(const e of n){const n=e.split(/\s*&&\s*/),u=[];for(const e of n){const[n,o,d]=e.split(/\s+/),[,h,,l]=d.match(w)||[],m="%"===l?i[n]:l,g=m&&parseFloat(h);let v;if(p.push(n),m)("%"===l?c:a).push(m),v=t(g,m);else{const e=d.match(f)?parseFloat(d):d;v=r(e)}u.push({[n]:s[o](v)})}o.push(u)}return{query:o,units:a,percentUnits:c,watchedProperties:p}},v=({query:e,unitsMeasurements:t,props:r})=>e.some(e=>e.every(e=>{const[[n,s]]=Object.entries(e);return s(t,r[n])})),b=["button","submit","image","checkbox","radio","hidden","range","reset"],y=e=>"INPUT"===e.tagName&&!b.includes(e.getAttribute("type"))||"TEXTAREA"===e.tagName,E=e=>y(e)?e.value.trim().length:e.isContentEditable?e.textContent.trim().length:0,C=e=>e.isContentEditable,q=(e,t)=>e.find(e=>e===t)||(t.parentNode?q(e,t.parentNode):void 0),U=(e,t,r=!1)=>{e.observe(t,{childList:!0,characterData:r,subtree:r})},$=e=>{const t=["width","height","orientation","aspect-ratio"];return e.some(e=>t.includes(e))},A=e=>e.includes("characters"),P=(e,t)=>A(e)&&t.isContentEditable,O=e=>e.includes("children"),j=(e,t)=>!y(t)&&(P(e,t)||O(e)),x=(e,t)=>{const r={};if($(t)){const{clientWidth:t,clientHeight:n}=e,{paddingTop:s,paddingRight:i,paddingBottom:o,paddingLeft:a}=window.getComputedStyle(e),c=t-(parseInt(a,10)+parseInt(i,10)),p=n-(parseInt(s,10)+parseInt(o,10));Object.assign(r,{width:c,height:p,orientation:d(c,p),"aspect-ratio":h(c,p)})}return A(t)&&(e.isContentEditable||y(e))&&(r.characters=E(e)),!O(t)||e.isContentEditable||y(e)||(r.children=e.childElementCount),r},L=new WeakMap,M=({elt:e,props:t,queries:r,units:n,percentUnits:s})=>{(({elt:e,props:t,queries:r,unitsMeasurements:n})=>{const s={...t,characters:t.characters||0,children:t.children||0};for(const[t,o]of r.entries()){const r=v({query:o,unitsMeasurements:n,props:s});var i;"string"==typeof t?e.classList.toggle(t,r):r!==Boolean(null==(i=L.get(e))?void 0:i.get(o))&&(t(e,s),L.get(e)||L.set(e,new WeakMap),L.get(e).set(o,r))}for(const[r,n]of Object.entries(t))e.style.setProperty("--ea-"+r,u(r)?n+"px":n)})({elt:e,props:t,queries:r,unitsMeasurements:{...c(e,n),...p(e,s)}})},B={},Q=`((width|height)\\s+(((>|<)=?)|==)\\s+\\d+(\\.\\d+)?(${m.join("|")}|px)|(characters|children)\\s+(((>|<)=?)|==)\\s+\\d+|aspect-ratio\\s+(((>|<)=?)|==)\\s+\\d+(\\.\\d+)?|orientation\\s+==\\s+(landscape|portrait|square))`,R=`${Q}(\\s+&&\\s+${Q})*`,N=new RegExp(`^\\s*${R}(\\s*,\\s*${R})*\\s*$`),k=["string","function"];export default function({target:t,queries:r={},...n}={}){(e=>{for(const[t,r]of Object.entries(e)){if(!t||!t.match(N))throw new Error(`invalid query "${t}"`);if(!k.includes(typeof r))throw new Error(`invalid behaviour "${r}"`)}})(r),(({watchedProperties:e})=>{if(e){if(!Array.isArray(e))throw new Error("watchedProperties must be an array");if(e.length<1||!e.every(e=>l.includes(e)))throw new Error("watchedProperties must be an array with at least one of "+l.join(", "))}})(n);const s=(e=>{if(!e)throw new Error("target must be provided");const t="length"in Object(e)?Array.isArray(e)?e:Array.from(e):[e];if(t.length<1)throw new Error("at least one Element must be provided as target");if(t.some(e=>!(e instanceof window.Element)))throw new Error(`target must be an Element or a list of Elements. Actual:\n[${t.map(e=>String(e)).join(", ")}]`);return t})(t),{compiledQueries:i,units:o,percentUnits:a,watchedProperties:c}=(t=>{const r=new Map,n=[],s=[],i=[];for(const[e,o]of Object.entries(t)){const t=g(e);r.set(o,t.query),n.push(...t.units),s.push(...t.percentUnits),i.push(...t.watchedProperties)}return{compiledQueries:r,units:e(n),percentUnits:e(s),watchedProperties:e(i)}})(r);if(c.length<1&&!n.watchedProperties)throw new Error("at least one query or one watched properties must be provided");const{unobserve:p,applyAdaptiveBehaviour:u}=(e=>{const{ResizeObserver:t,MutationObserver:r}=window,n=new WeakMap,s={...e,propsCache:n},{elements:i,compiledQueries:o,units:a,percentUnits:c,watchedProperties:p}=e,u=$(p)&&(({propsCache:e,compiledQueries:t,units:r,percentUnits:n})=>s=>{for(const{contentRect:{width:i,height:o},target:a}of s){const s={...e.get(a),width:i,height:o,orientation:d(i,o),"aspect-ratio":h(i,o)};e.set(a,s),window.requestAnimationFrame(()=>M({elt:a,props:s,queries:t,units:r,percentUnits:n}))}})(s),m=u&&new t(u),w=A(p)&&i.some(y)&&(({propsCache:e,compiledQueries:t,units:r,percentUnits:n})=>({target:s})=>{const i=s.value.trim().length,o=e.get(s);if(i!==o.characters){const i={...o,characters:E(s)};e.set(s,i),M({elt:s,props:i,queries:t,units:r,percentUnits:n})}})(s),f=(O(p)&&!i.every(y)||A(p)&&i.some(C))&&(({propsCache:e,compiledQueries:t,units:r,percentUnits:n,elements:s,watchedProperties:i})=>(o,a)=>{a.disconnect();for(const{type:a,target:c}of o)if(["childList","characterData"].includes(a)){const o=q(s,c);if(o){let s,a;const c={...e.get(o)};O(i)&&!o.isContentEditable&&(c.children=o.childElementCount,s=!0),P(i,o)&&(c.characters=E(o),a=!0),(s||a)&&(e.set(o,c),M({elt:o,props:c,queries:t,units:r,percentUnits:n}))}}for(const e of s)j(i,e)&&U(a,e,P(i,e))})(s),g=f&&new r(f);for(const e of i){const t=x(e,p);n.set(e,t),m&&m.observe(e),w&&y(e)&&e.addEventListener("input",w),g&&j(p,e)&&g&&U(g,e,P(p,e)),M({elt:e,props:t,queries:o,units:a,percentUnits:c})}return{unobserve:()=>{n.set(B,!0),(({elements:e,mutationObserver:t,resizeObserver:r,inputListener:n,behaviours:s})=>{t&&t.disconnect();const i=s.filter(e=>"string"==typeof e);for(const t of e)r&&r.unobserve(t),n&&y(t)&&t.removeEventListener("input",n),t.classList.remove(...i),l.forEach(e=>t.style.removeProperty("--ea-"+e))})({elements:i,mutationObserver:g,resizeObserver:m,inputListener:w,behaviours:[...o.keys()]}),function(e){for(const t of e)L.delete(t)}(i)},applyAdaptiveBehaviour:()=>{n.get(B)||i.forEach(e=>M({elt:e,props:n.get(e),queries:o,units:a,percentUnits:c}))}}})({elements:s,compiledQueries:i,units:o,percentUnits:a,watchedProperties:e([...c,...n.watchedProperties||[]])});return{removeAdaptiveBehaviour:p,applyAdaptiveBehaviour:u}}
